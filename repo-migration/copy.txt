# --------------------------------
# Configuration and Environment
# --------------------------------
$tfsPat = $env:TFS_PAT
$githubPat = $env:GITHUB_PAT

if (-not $tfsPat -or -not $githubPat) {
    Write-Error "‚ùå Environment variables TFS_PAT and GITHUB_PAT must be set."
    exit 1
}

$base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("user:$tfsPat"))

$organization = "https://tfs.sys.cigna.com/tfs/DefaultCollection"
$destinationOrg = "cigna-group-infrastructure-services"

# GitHub workspace and working directories
$workspaceRoot = "$env:GITHUB_WORKSPACE\temp_migration"
$logFile = Join-Path $workspaceRoot "conversionlog.txt"

# Set environment for git-tfs
[System.Environment]::SetEnvironmentVariable("GIT_TFS_PAT", $tfsPat, [System.EnvironmentVariableTarget]::User)
git config --global http.sslVerify false

# Create workspace root
if (-not (Test-Path $workspaceRoot)) {
    New-Item -Path $workspaceRoot -ItemType Directory | Out-Null
}

# -------------------------------
# Load project-repo mapping JSON
# -------------------------------
$projectJsonPath = "$env:GITHUB_WORKSPACE\repo-migration\projectRepoDetailsTFS2017.json"
if (-not (Test-Path $projectJsonPath)) {
    Write-Error "‚ùå JSON file not found at: $projectJsonPath"
    exit 1
}

$projectData = Get-Content -Raw $projectJsonPath | ConvertFrom-Json

# -------------------------------
# Log Helper Function
# -------------------------------
function Log {
    param([string]$message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "$timestamp - $message"
    Write-Host $logMessage
    Add-Content -Path $logFile -Value $logMessage
}

# -------------------------------
# GitHub Repo Creation Function
# -------------------------------
function Create-GitHubRepo {
    param([string]$repoName)

    $url = "https://api.github.com/orgs/$destinationOrg/repos"
    $headers = @{
        Authorization = "token $githubPat"
        "User-Agent"  = "TFVC-Migration-Script"
        Accept        = "application/vnd.github+json"
    }

    $body = @{
        name        = $repoName
        visibility  = "internal"
        description = "Migrated from TFS TFVC: $repoName"
    } | ConvertTo-Json -Depth 3

    try {
        Log "üîß Creating GitHub repo: $repoName"
        Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body $body -ErrorAction Stop | Out-Null
        Log "‚úÖ Created GitHub repo: $repoName"
        return $true
    } catch {
        $statusCode = $_.Exception.Response.StatusCode.Value__
        $responseBody = (New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())).ReadToEnd()
        Log "‚ùå GitHub repo creation failed: $repoName - Status: $statusCode - $responseBody"

        if ($statusCode -eq 422 -and $responseBody -match "already exists") {
            Log "‚ö†Ô∏è Repo $repoName already exists. Continuing..."
            return $true
        }

        return $false
    }
}

# -------------------------------
# Main Migration Loop
# -------------------------------
foreach ($project in $projectData) {
    if (-not $project -or -not $project.ProjectName) {
        Log "‚ö†Ô∏è Skipping invalid project entry"
        continue
    }

    $projectName = $project.ProjectName.Trim()
    Log "`nüöÄ Starting migration for project: $projectName"

    foreach ($repo in $project.Repositories) {
        if ($repo.RepositoryType -ne "TFVC") {
            Log "‚ö†Ô∏è Skipping non-TFVC repo: $($repo.RepositoryName)"
            continue
        }

        $tfvcPath = $repo.RepositoryName
        $repoNameRaw = ($tfvcPath -split '/')[-1] -replace '[^\w\-]', '-'
        $repoPath = Join-Path $workspaceRoot $repoNameRaw

        # Create GitHub repo
        if (-not (Create-GitHubRepo -repoName $repoNameRaw)) {
            Log "‚ùå Skipping repo due to GitHub creation failure: $repoNameRaw"
            continue
        }

        # Clean old directory
        if (Test-Path $repoPath) {
            Remove-Item -Recurse -Force $repoPath
            Log "üßπ Removed existing directory: $repoPath"
        }

        # Clone from TFVC using git-tfs
        New-Item -ItemType Directory -Path $repoPath | Out-Null
        $gitTfsCmd = "git tfs clone $organization `"$tfvcPath`" `"$repoPath`" --branches=auto --username=PersonalAccessToken --password=$tfsPat --no-ssl-verify"
        Log "üì• Executing: $gitTfsCmd"

        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = "cmd.exe"
        $processInfo.Arguments = "/c $gitTfsCmd"
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.UseShellExecute = $false
        $processInfo.CreateNoWindow = $true

        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $processInfo
        $process.Start() | Out-Null
        $stdout = $process.StandardOutput.ReadToEnd()
        $stderr = $process.StandardError.ReadToEnd()
        $process.WaitForExit()

        Log "git-tfs output: $stdout"
        if ($stderr) { Log "git-tfs errors: $stderr" }

        if (-not (Test-Path (Join-Path $repoPath ".git"))) {
            Log "‚ùå git-tfs failed, no .git directory at $repoPath"
            continue
        }

        # Push to GitHub
        Push-Location $repoPath

        if (git remote | Select-String -Pattern "^origin$") {
            git remote remove origin
            Log "üîÑ Removed existing origin"
        }

        $remoteUrl = "https://$githubPat@github.com/$destinationOrg/$repoNameRaw.git"
        git remote add origin $remoteUrl
        Log "üîó Added origin: $remoteUrl"

        Log "‚¨ÜÔ∏è Pushing all branches and tags to GitHub..."
        git push -u origin --all
        git push origin --tags

        Log "üßπ Running git tfs cleanup"
        git tfs cleanup

        Pop-Location
    }
}

Log "`n‚úÖ All migrations completed successfully!"
