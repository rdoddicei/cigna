param(
    [Parameter(Mandatory = $true)] [string]$TfsUrl,
    [Parameter(Mandatory = $true)] [string]$GitHubOrg,
    [Parameter(Mandatory = $true)] [string]$JsonFilePath
)

# Set tokens
$TfsToken = "YOUR_TFS_PAT"
$GitHubToken = "YOUR_GITHUB_PAT"

if (-not $TfsToken) { throw "Missing TFS_TOKEN in script." }
if (-not $GitHubToken) { throw "Missing GITHUB_TOKEN in script." }

# Create working directory
$workingDir = Join-Path -Path $PWD -ChildPath "repo"
if (-not (Test-Path $workingDir)) {
    New-Item -ItemType Directory -Path $workingDir | Out-Null
}

# Load input JSON
if (-not (Test-Path $JsonFilePath)) {
    throw "JSON input file not found: $JsonFilePath"
}

$jsonContent = Get-Content -Raw -Path $JsonFilePath | ConvertFrom-Json
Write-Output "Loaded $($jsonContent.Count) project(s) from input JSON"

# Process each project and its repositories
foreach ($project in $jsonContent) {
    $projectName = $project.ProjectName
    $repositories = $project.Repositories

    Write-Output "Processing Project: $projectName"

    foreach ($repo in $repositories) {
        $repoPath = $repo.RepositoryName
        $repoType = $repo.RepositoryType.ToUpper()

        $cleanRepoPath = $repoPath -replace "^\$/", ""
        $pathParts = $cleanRepoPath -split '/'

        if ($pathParts.Length -lt 2) {
            Write-Output "Invalid repo path format: $repoPath"
            continue
        }

        $projectPart = $pathParts[0]
        $repoName = ($pathParts[-1])
        $repoSubPath = ($pathParts | Select-Object -Skip 1) -join '/'
        $tfsGitUrl = "$TfsUrl/$projectPart/_git/$repoSubPath"

        $localRepoPath = Join-Path -Path $workingDir -ChildPath $repoName
        Write-Output "Processing Repository: $repoName (Type: $repoType)"

        # Create GitHub repository
        $createRepoUri = "https://api.github.com/orgs/$GitHubOrg/repos"
        $repoBody = @{
            name = $repoName
            visibility = "internal"
            auto_init = $false
        } | ConvertTo-Json -Depth 3

        $headers = @{
            Authorization = "token $GitHubToken"
            Accept = "application/vnd.github.v3+json"
            "User-Agent" = "PowerShell-MigrationScript"
        }

        try {
            $response = Invoke-RestMethod -Uri $createRepoUri -Method Post -Headers $headers -Body $repoBody
            Write-Output "GitHub repo created: $($response.full_name)"
        } catch {
            Write-Output "Skipping repo: $repoName - GitHub repo may already exist or failed to create"
            continue
        }

        if ($repoType -eq "GIT") {
            # Clone TFS Git repo
            if (Test-Path $localRepoPath) {
                Remove-Item -Recurse -Force -Path $localRepoPath
            }

            Write-Output "Cloning from TFS: $tfsGitUrl"
            git config --global credential.helper ""

            $secureCloneUrl = $tfsGitUrl -replace "^https://", "https://user:$TfsToken@"

            git -c http.sslVerify=false clone $secureCloneUrl $localRepoPath
            if ($LASTEXITCODE -ne 0) {
                Write-Output "Git clone failed. Skipping $repoName"
                continue
            }

            # Push to GitHub
            Write-Output "Pushing to GitHub: $repoName"
            Set-Location -Path $localRepoPath

            git remote add origin "https://$GitHubToken@github.com/$GitHubOrg/$repoName.git"
            git push origin --all
            git push origin --tags

            Set-Location -Path $workingDir

            # Cleanup local repo
            Remove-Item -Recurse -Force -Path $localRepoPath
            Write-Output "Cleaned local repo: $repoName"

        } elseif ($repoType -eq "TFVC") {
            Write-Output "Skipping TFVC repo: $repoName - Not supported"
        } else {
            Write-Output "Unknown repo type: $repoType"
        }

        Write-Output "Done: $repoName"
    }

    Write-Output "Completed Project: $projectName"
}

Write-Output "All repositories processed"
